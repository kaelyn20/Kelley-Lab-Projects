---
title: "R Notebook"
output: html_notebook
---

```{r}

#Load libraries

library("dplyr")
library("ggplot2")
library("vegan")
library("RColorBrewer")
library("zCompositions")
#library(mixOmics)
library("lattice")
library("ggpubr")

```

```{r}

#read in data and store in df, filter to only include only bacteria
storm <- read.csv("~/Kelley_Lab/Stormwater_data.csv")
storm_mod <- filter(storm, domain == "Bacteria")

```


```{r}
#sort by phylum and sum values for repeating phylums
by_phylum <- storm_mod[, c(3, 9:21)]
p_counts <- by_phylum %>% group_by(phylum) %>% summarise_all(sum)
phylums <- p_counts$phylum
phyclums[135] <- "Undetermined"
p_counts <- p_counts[, 2:14]
rownames(p_counts) <- phylums

#richness
richness = data.frame(matrix(nrow = 13, ncol = 2))

for (i in 1:13) { 
  richness[i, 2] <- length(which(p_counts[i]>0))
  richness[i, 1] <- colnames(p_counts[i]) 
}
colnames(richness) <- c("Sites", "Richness")
ggplot(richness, mapping = aes(x= Sites, y = Richness)) + geom_bar(stat = "identity")

#get total counts for all samples
totals <-colSums(p_counts)

#shannon diversity
shannon <- diversity(tr_pcounts)
shannondf <- data.frame('Names' = names(shannon), "ShannonDiversity" = shannon)
ggplot(shannondf, mapping = aes(x= Names, y = ShannonDiversity)) + geom_bar(stat = "identity")


#Pielou's evenness
evenness = shannon/log(totals)
df <- data.frame('Names' = names(evenness), "Evenness" = evenness)
ggplot(df, mapping = aes(x= Names, y = Evenness)) + geom_bar(stat = "identity")

#simpson diversity
simpson <- diversity(p_counts)
hist(simpson)
```

```{r}
#calculate relative abundances and plot them
rcnt <- nrow(p_counts)
ccnt <- ncol(p_counts)

r_abund <- data.frame(matrix(nrow=rcnt, ncol = ccnt))
colnames(r_abund) <- colnames(p_counts)

for(i in 1:13) {
  r_abund[i] <- round(p_counts[i]/totals[i], 4)
}
rownames(r_abund) <- rownames(p_counts)


above1 <- r_abund %>% filter_all(any_vars(. > .01))
above5 <- r_abund %>% filter_all(any_vars(. > .05))

#Phyla with more than 1% of relative abundance
barplot(as.matrix(above1), col = brewer.pal(8, "Accent"), legend.text = rownames(above1), xlim = c(0, 20), args.legend = list(x = "topright", inset = c(-.12, 0)) )

#Phyla with more than 5% of relative abundance
barplot(as.matrix(above5), col = brewer.pal(6, "Accent"), legend.text = rownames(above5), xlim = c(0, 20), args.legend = list(x = "topright", inset = c(-.12, 0)) ) 
```


```{r}
#Bray Curtis
bray <- vegdist(p_counts, "bray")

#CLR transform
bac_z <- cmultRepl(as.matrix(p_counts), output = 'p-counts')
clr <- function(x) sweep(log(x), 1, rowMeans(log(x)), "-")
bac_tx <- data.frame(t(clr(t(bac_z))))
```

``` {r}
#rarefaction
raremin <- min(totals) #finds smallest value of totals
tr_pcounts <- t(p_counts)
rarefy(tr_pcounts, raremin)
rarecurve(tr_pcounts, step = 1000, sample = raremin, col = "blue")
#NMDS

```
